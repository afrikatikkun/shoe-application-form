<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Apply for Shoes</title>
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 40px; display: flex; justify-content: center; }
    .form-container { width: 95%; max-width: 900px; border: 2px solid #888; border-radius: 10px; padding: 30px 40px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    h1 { text-align: center; font-size: 2rem; margin-bottom: 30px; }
    .form-step { display: none; }
    .form-step.active { display: block; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .required-field { color:#c8102e; }
    .form-group { display: flex; flex-direction: column; }
    .form-group input, .form-group select { padding: 12px; border: 2px solid #ccc; border-radius: 8px; font-size: 16px; background: #fff; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23666"><path d="M7.247 11.14l-4.796-5.481..."/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; padding-right: 40px; }
    .form-group label { margin-bottom: 8px; font-weight: bold; }
    .full-width { grid-column: 1 / -1; }
    .file-input { padding: 10px; border: 2px dashed #ccc; background-color:#f9f9f9; border-radius:8px; cursor:pointer; }
    .form-check { display:flex; align-items:center; gap:10px; margin-top:10px; }
    .form-check label { font-size:0.95rem; }
    .btn-group { text-align:center; margin-top:30px; }
    .step-btn { background-color:#c8102e; color:#fff; border:none; padding:12px 24px; font-size:1rem; border-radius:8px; margin:0 10px; cursor:pointer; }
    .step-btn:hover { background-color:#a00b24; }
    .step-indicator { display:flex; justify-content:center; gap:10px; margin-bottom:20px; }
    .step-indicator div { width:12px; height:12px; background:#ccc; border-radius:50%; }
    .step-indicator .active { background:#c8102e; }
    .flatpickr-input { background-color:#fff; border:2px solid #ccc; border-radius:8px; padding:12px; font-size:16px; }
    #loader { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); border:8px solid #f3f3f3; border-top:8px solid #c8102e; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite; background:rgba(255,255,255,0.8); z-index:9999; }
    @keyframes spin { 0% {transform:translate(-50%,-50%) rotate(0deg);} 100% {transform:translate(-50%,-50%) rotate(360deg);} }
    #successMsg { display:none; text-align:center; margin-top:20px; font-size:1.1rem; }
    .grecaptcha-badge { bottom:10px!important; right:10px!important; }
  </style>
</head>
<body>
  <div class="form-container">
    <h1>Application Form</h1>
    <div class="step-indicator">
      <div class="active"></div><div></div><div></div>
    </div>
    <form id="multiStepForm">
      <!-- STEP 1 -->
      <div class="form-step active">
        <div class="form-grid">
          <div class="form-group"><label>Organization Name <span class="required-field">*</span></label><input type="text" required name="orgName"></div>
          <div class="form-group"><label>NPO Registration Number <span class="required-field">*</span></label><input type="text" required name="npoReg"></div>
          <div class="form-group"><label>Date of Registration <span class="required-field">*</span></label><input type="text" required name="regDate"></div>
          <div class="form-group"><label>Registration Status <span class="required-field">*</span></label><select required name="regStatus"><option value="" disabled selected>Select</option><option>Active</option><option>Pending</option><option>Inactive</option></select></div>
          <div class="form-group full-width"><label>Province <span class="required-field">*</span></label><select required name="province"><option value="" disabled selected>Select</option><option>Gauteng</option><option>Free State</option><option>Eastern Cape</option><option>KwaZulu-Natal</option><option>Limpopo</option><option>Mpumalanga</option><option>Northern Cape</option><option>North West</option><option>Western Cape</option></select></div>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="form-step">
        <div class="form-grid">
          <div class="form-group"><label>Name <span class="required-field">*</span></label><input type="text" required name="firstName"></div>
          <div class="form-group"><label>Surname <span class="required-field">*</span></label><input type="text" required name="lastName"></div>
          <div class="form-group"><label>Email <span class="required-field">*</span></label><input type="email" required name="email"></div>
          <div class="form-group"><label>Contact Number <span class="required-field">*</span></label><input type="tel" required name="contact"></div>
          <div class="form-group full-width"><label>Delivery Address Line 1 <span class="required-field">*</span></label><input type="text" required name="address1"></div>
          <div class="form-group full-width"><label>Delivery Address Line 2</label><input type="text" name="address2"></div>
          <div class="form-group"><label>City <span class="required-field">*</span></label><input type="text" required name="city"></div>
          <div class="form-group"><label>Postal Code <span class="required-field">*</span></label><input type="text" required name="postalCode"></div>
          <div class="form-group full-width"><label>Delivery Province <span class="required-field">*</span></label><select required name="deliveryProvince"><option value="" disabled selected>Select</option><option>Gauteng</option><option>Free State</option><option>Eastern Cape</option><option>KwaZulu-Natal</option><option>Limpopo</option><option>Mpumalanga</option><option>Northern Cape</option><option>North West</option><option>Western Cape</option></select></div>
        </div>
        <div class="form-group full-width">
          <label>Shoe Requirements <span class="required-field">*</span></label>
          <div style="max-height:300px; overflow-y:auto; border:1px solid #ccc; border-radius:8px; padding:10px;">
            <table style="width:100%; border-collapse:collapse;"><thead><tr><th>Gender</th><th>Size</th><th>Qty</th></tr></thead><tbody id="shoeTableBody"></tbody></table>
          </div>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="form-step">
        <div class="form-grid">
          <div class="form-group full-width"><label>Upload NPO Certificate <span class="required-field">*</span></label><input type="file" name="npoCert" class="file-input" required accept="application/pdf"></div>
          <div class="form-group full-width"><label>Upload Proposal <span class="required-field">*</span></label><input type="file" name="proposal" class="file-input" required accept="application/pdf"></div>
          <div class="form-group full-width"><label>Upload ID/Passport <span class="required-field">*</span></label><input type="file" name="idDoc" class="file-input" required accept="application/pdf"></div>
          <div class="form-group full-width"><label>Upload Declaration <span class="required-field">*</span></label><input type="file" name="declaration" class="file-input" required accept="application/pdf"></div>
          <div class="form-check full-width"><input type="checkbox" id="policy" name="policyCheck" required><label for="policy">I acknowledge the <a href="#">Privacy Policy</a> <span class="required-field">*</span></label></div>
        </div>
      </div>

      <div class="btn-group">
        <button type="button" class="step-btn" id="prevBtn">Back</button>
        <button type="button" class="step-btn" id="nextBtn">Next</button>
      </div>
    </form>

    <div id="loader"></div>
    <div id="successMsg">âœ“ Thank you! Your application was submitted successfully.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://www.google.com/recaptcha/api.js?render=6Lc6EV0rAAAAAC8thOVwagnJdDCBV2J47pDrXw4p"></script>
  <script>
    // flatpickr
    flatpickr("input[type='text'][name='regDate']", {
      altInput:true, altFormat:"F j, Y", dateFormat:"Y-m-d", maxDate:"today", allowInput:true
    });

    let currentStep=0;
    const steps=document.querySelectorAll(".form-step");
    const indicators=document.querySelectorAll(".step-indicator div");
    const btnPrev=document.getElementById("prevBtn"), btnNext=document.getElementById("nextBtn");

    function generateShoeMatrix(){
      const tbl=document.getElementById("shoeTableBody");
      ['Male','Female'].forEach(g=>{
        for(let s=100;s<=105;s++){
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${g}</td><td>${s}</td><td><input type="number" name="${g}_${s}" min="0" value="0" style="width:80px;"></td>`;
          tbl.appendChild(tr);
        }
      });
    }
    generateShoeMatrix();

    function showStep(n){
      steps.forEach((s,i)=>s.classList.toggle("active",i===n));
      indicators.forEach((d,i)=>d.classList.toggle("active",i===n));
      btnPrev.style.display = n===0?'none':'inline-block';
      btnNext.innerText = (n===steps.length-1)?'Submit':'Next';
      btnNext.onclick = (n===steps.length-1)?submitWithRecaptcha:()=> nextPrev(1);
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function nextPrev(n){
      if(n===1 && !validateStep()) return;
      currentStep+=n;
      if(currentStep<steps.length) showStep(currentStep);
    }

    function validateStep(){
      return [...steps[currentStep].querySelectorAll("input[required],select[required]")]
        .every(el=>el.checkValidity());
    }

    function toBase64(file){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(r.result.split(",")[1]);
        r.onerror=rej;
        r.readAsDataURL(file);
      });
    }

    async function buildPayload(token){
      const form=document.getElementById("multiStepForm");
      const data={recaptcha:token,shoes:[],files:{}};
      new FormData(form).forEach((v,k)=>data[k]=v);
      document.querySelectorAll("#shoeTableBody input").forEach(inp=>{
        const [g,s]=inp.name.split("_");
        const q=+inp.value;
        if(q>0) data.shoes.push({gender:g,size:s,qty:q});
      });
      for(const fi of form.querySelectorAll("input[type=file]")){
        const f=fi.files[0];
        if(!f) continue;
        const base = await toBase64(f);
        data.files[fi.name]={fileName:f.name,fileType:f.type,content:base};
      }
      return data;
    }

    async function sendToPA(payload){
      document.getElementById("loader").style.display="block";
      try {
        const r=await fetch("https://prod-148.westeurope.logic.azure.com:443/workflows/2fae90b798864ce286650ebe763180f3/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=qrYOBdBKjXoRSLFAdM7EaDhXIq9ZS0Fub-w8-E8wCaM",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify(payload)
        });
        document.getElementById("loader").style.display="none";
        if(r.ok){
          document.getElementById("multiStepForm").style.display="none";
          document.getElementById("successMsg").style.display="block";
        } else {
          throw new Error("Submission failed");
        }
      } catch(e){
        alert(e.message);
        btnNext.disabled=false; btnNext.innerText="Submit";
      }
    }

    async function submitWithRecaptcha(){
      const form=document.getElementById("multiStepForm");
      if(!form.checkValidity()){ form.reportValidity(); return; }
      btnNext.disabled=true; btnNext.innerText="Submitting...";
      grecaptcha.ready(()=>{
        grecaptcha.execute('6Lc6EV0rAAAAAC8thOVwagnJdDCBV2J47pDrXw4p',{action:'submit'})
          .then(async token => sendToPA(await buildPayload(token)))
          .catch(err=>{
            console.error(err);
            alert("reCAPTCHA error");
            btnNext.disabled=false; btnNext.innerText="Submit";
          });
      });
    }

    showStep(currentStep);
  </script>
</body>
</html>
